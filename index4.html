<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ä¸­â†”éŸ“ åŒè²å‚³è­¯ / ì¤‘â†”í•œ ë™ì‹œí†µì—­ï½œè‡ªå·±ç«¯ç„¡è² Â· ä»–äººè½MP3</title>
<style>
  :root{
    --bg: #0b1220; --card: rgba(255,255,255,.06); --card-border: rgba(255,255,255,.12);
    --text: #e8eefb; --muted: #9fb0c9; --accent: #6ea8fe; --accent-2: #22d3ee;
    --ok: #10b981; --warn: #f59e0b; --danger: #ef4444; --chip: rgba(255,255,255,.14);
    --chip-text:#d9e4ff;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,"Noto Sans TC","Noto Sans KR","Microsoft JhengHei","Apple SD Gothic Neo",Segoe UI,Roboto,Helvetica,Arial;
    background:
      radial-gradient(1200px 600px at 10% 0%, #1a2744 0%, transparent 60%),
      radial-gradient(1000px 500px at 100% 0%, #0f2a38 0%, transparent 60%),
      linear-gradient(180deg, #0b1220 0%, #0b1220 100%);
    padding:28px;
  }
  .wrap{max-width:1080px;margin:auto}
  h1{margin:0 0 14px 0; letter-spacing:.4px; font-weight:800; line-height:1.2; font-size:clamp(20px,3vw,28px)}
  .sub{color:var(--muted); font-size:13px; margin-bottom:18px}
  .grid{display:grid; gap:16px; grid-template-columns: 1fr;}
  @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr .8fr; } }
  .card{ background:var(--card); border:1px solid var(--card-border); border-radius:16px; padding:16px;
    backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06); }
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  label{font-size:13px; color:var(--muted)}
  .k{font-size:12px; color:var(--muted); margin-left:6px}
  input,select,button{
    padding:10px 12px; border:1px solid var(--card-border); border-radius:12px; background:rgba(255,255,255,.06); color:var(--text);
    outline:none; transition: all .15s ease;
  }
  input:focus,select:focus{border-color:var(--accent)} select{cursor:pointer}
  button{cursor:pointer; border:1px solid transparent; background:linear-gradient(135deg, var(--accent), var(--accent-2));
    color:#0b1220; font-weight:700; box-shadow:0 6px 20px rgba(34,211,238,.28);}
  button.ghost{ background: transparent; color:var(--text); border-color:var(--card-border); }
  button[disabled]{opacity:.55; cursor:not-allowed; filter:grayscale(40%)}
  .pill{ padding:6px 12px; border-radius:999px; background:var(--chip); color:var(--chip-text); font-size:12px; display:inline-flex; align-items:center; gap:6px }
  .pill.now{ background:rgba(16,185,129,.18); color:#bff7e6; border:1px solid rgba(16,185,129,.35)}
  .stat{font-family:ui-monospace,Menlo,Consolas,monospace; color:#bcd2ff}
  .hint{color:var(--muted); font-size:12.5px; line-height:1.7}
  .section-title{font-weight:700; margin-bottom:8px; letter-spacing:.3px}
  .logs{ margin-top:10px; padding:12px; border:1px dashed var(--card-border); border-radius:12px; background:rgba(10,17,30,.55); height:420px; overflow:auto; font-size:14px; white-space:pre-wrap; }
  .divider{height:1px; background:var(--card-border); margin:10px 0}
  .spacer{flex:1} .bad{color:var(--danger)} .ok{color:var(--ok)} .warn{color:var(--warn)}
</style>

<body>
  <div class="wrap">
    <h1>ä¸­â†”éŸ“ åŒè²å‚³è­¯ <span class="k">/ ì¤‘â†”í•œ ë™ì‹œí†µì—­</span></h1>
    <div class="sub">è‡ªå·±ç«¯ï¼šä¸æ’­æ”¾ä»»ä½•äººè²ï¼›ä»–äººï¼šåªè½è­¯éŸ³ MP3ï¼ˆå¤±æ•—ä»¥æ–‡å­—å‚™æ´ï¼‰
      <span class="k">/ ë‚´ ìª½: ì›ìŒÂ·ë²ˆì—­ìŒ ëª¨ë‘ ë¬´ìŒ Â· ìƒëŒ€: ë²ˆì—­ MP3(ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸)</span>
    </div>

    <div class="grid">
      <div class="card">
        <div class="section-title">é€£ç·šèˆ‡æœƒè©± <span class="k">/ ì—°ê²° & ì„¸ì…˜</span></div>
        <div class="row" style="margin-bottom:10px">
          <label for="name">åç¨± <span class="k">/ ì´ë¦„</span></label>
          <input id="name" type="text" value="Public" placeholder="ä½ çš„ä»£è™Ÿ / ë‹‰ë„¤ì„"/>

          <label for="srcLang">ä¾†æºèªè¨€ <span class="k">/ ì›ë³¸ ì–¸ì–´</span></label>
          <select id="srcLang" title="ä¾†æºèªè¨€ / ì›ë³¸ ì–¸ì–´">
            <option value="zh" selected>ä¸­æ–‡ (zh) / ì¤‘êµ­ì–´</option>
            <option value="ko">éŸ“æ–‡ (ko) / í•œêµ­ì–´</option>
          </select>

          <button id="join">åŠ å…¥ / ì°¸ì—¬</button>
          <button id="leave" class="ghost" disabled>é›¢é–‹ / ë‚˜ê°€ê¸°</button>

          <span class="pill" id="status">æœªé€£ç·š / ë¯¸ì—°ê²°</span>
          <span class="spacer"></span>
          <span class="stat" id="tx">TX: 0 pkt/s</span>
        </div>

        <div class="divider"></div>

        <div class="section-title">éŸ³è¨Šåå¥½ <span class="k">/ ì˜¤ë””ì˜¤ ì„¤ì •</span></div>
        <div class="row" style="margin-bottom:8px">
          <label><input id="mute" type="checkbox"> ä¸é€å‡ºéº¥å…‹é¢¨ / ë§ˆì´í¬ ì „ì†¡ ì•ˆ í•¨</label>
          <label><input id="echo" type="checkbox" checked> å›è²æŠ‘åˆ¶ / ì—ì½” ì–µì œ</label>
          <label><input id="ns"   type="checkbox" checked> é™å™ª / ì†ŒìŒ ì–µì œ</label>
          <label><input id="agc"  type="checkbox"> è‡ªå‹•å¢ç›Š / ìë™ ì¦í­</label>
        </div>

        <div class="divider"></div>

        <div class="section-title">è£ç½®é¸æ“‡ <span class="k">/ ì¥ì¹˜ ì„ íƒ</span></div>
        <div class="row" style="margin-bottom:6px">
          <label for="micSel">è¼¸å…¥è£ç½® / ì…ë ¥ ì¥ì¹˜</label>
          <select id="micSel"></select>

          <label for="outSel">è¼¸å‡ºè£ç½®ï¼ˆæ’­æ”¾ä»–äººè­¯éŸ³ MP3ï¼‰ / ì¶œë ¥ ì¥ì¹˜</label>
          <select id="outSel"></select>
        </div>

        <p class="hint">
          ä¼ºæœå™¨åƒ…å‚³ã€Œè­¯éŸ³ MP3ã€çµ¦å…¶ä»–äººï¼›ç™¼è©±è€…æœ¬äººä¸æœƒæ”¶åˆ°ä»»ä½•äººè²ã€‚MP3 å¤±æ•—æ™‚æ”¹å‚³ã€Œæ–‡å­—å‚™æ´ã€ï¼Œç”±å°æ–¹ç€è¦½å™¨æœ¬åœ°æœ—è®€ã€‚
        </p>
      </div>

      <div class="card">
        <div class="section-title">è¨Šæ¯ç´€éŒ„ <span class="k">/ ë¡œê·¸</span></div>
        <div class="logs" id="logs"></div>
      </div>
    </div>
  </div>

<script>
function getHostFromQuery(){
  const u = new URL(location.href);
  return (u.searchParams.get("host") || "").trim();
}
const DEFAULT_HOST = "sky-tapes-restoration-brian.trycloudflare.com";
const TUNNEL_HOST = "https://" + (getHostFromQuery() || DEFAULT_HOST);

let ws=null, audioCtx=null, worklet=null, sp=null, stream=null, pingTimer=null, txTimer=null;
let txPkts=0;

let devicesCache=[]; let currentMicId=""; let currentOutId="";

const $ = (s)=>document.querySelector(s);
const log = (s)=>{ const el=$('#logs'); el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight; };

async function refreshDevices(){
  devicesCache = await navigator.mediaDevices.enumerateDevices();
  const mics = devicesCache.filter(d=>d.kind==="audioinput");
  const outs = devicesCache.filter(d=>d.kind==="audiooutput");
  const micSel=$('#micSel'); micSel.innerHTML="";
  mics.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label || `éº¥å…‹é¢¨/ë§ˆì´í¬(${d.deviceId.slice(0,6)}â€¦)`; micSel.appendChild(o); });
  const outSel=$('#outSel'); outSel.innerHTML="";
  outs.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label || `è¼¸å‡º/ì¶œë ¥(${d.deviceId.slice(0,6)}â€¦)`; outSel.appendChild(o); });
  if (currentMicId && [...micSel.options].some(o=>o.value===currentMicId)) micSel.value=currentMicId;
  if (currentOutId && [...outSel.options].some(o=>o.value===currentOutId)) outSel.value=currentOutId;
}

async function getMicStream(deviceId){
  const cts = {
    audio:{
      deviceId: deviceId ? {exact: deviceId} : undefined,
      channelCount:{ideal:1}, sampleRate:{ideal:48000}, sampleSize:{ideal:16},
      echoCancellation:{ideal: $('#echo').checked},
      noiseSuppression:{ideal: $('#ns').checked},
      autoGainControl:{ideal: $('#agc').checked}
    }
  };
  return await navigator.mediaDevices.getUserMedia(cts);
}

function cleanupAudio(){
  try{ worklet && worklet.disconnect(); }catch(_){}
  try{ sp && sp.disconnect(); }catch(_){}
  try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ audioCtx && audioCtx.close(); }catch(_){}
  try{ clearInterval(pingTimer); }catch(_){}
  try{ clearInterval(txTimer); }catch(_){}
  worklet=sp=null; audioCtx=null; stream=null; pingTimer=txTimer=null; txPkts=0;
}
function leave(){
  if(ws){ try{ ws.close(); }catch(_){} }
  cleanupAudio();
  $('#join').disabled=false; $('#leave').disabled=true;
  $('#status').textContent="æœªé€£ç·š / ë¯¸ì—°ê²°"; $('#status').classList.remove('now');
}

async function fallbackScriptProcessor(source){
  const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0; // è‡ªå·±ç«¯æ°¸ä¹…ç„¡è²
  sp = audioCtx.createScriptProcessor(2048,1,1);
  sp.onaudioprocess = (ev)=>{
    const ch=ev.inputBuffer.getChannelData(0);
    const ratio=48000/16000;
    const outLen=Math.floor(ch.length/ratio);
    const pcm=new Int16Array(outLen);
    for(let i=0;i<outLen;i++){
      const idx=(i*ratio)|0; let s=ch[idx];
      if(s>1) s=1; if(s<-1) s=-1;
      pcm[i]=s<0?s*0x8000:s*0x7FFF;
    }
    const pkt=320;
    for(let off=0; off<pcm.length; off+=pkt){
      const sl=pcm.subarray(off, off+pkt);
      if(sl.length===pkt){
        txPkts++;
        if(!$('#mute').checked && ws && ws.readyState===1){
          ws.send(sl.buffer);
        }
      }
    }
  };
  source.connect(sp); sp.connect(zeroGain); zeroGain.connect(audioCtx.destination);
  log(`âœ… ScriptProcessor å•Ÿç”¨ï¼ˆctxRate=${audioCtx.sampleRate}Hzï¼‰`);
}

async function join(){
  try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch(_){}
  await refreshDevices();

  const name = ($('#name').value || 'Guest').trim().slice(0,40);
  const srcLang = $('#srcLang').value;

  ws = new WebSocket(`${TUNNEL_HOST.replace('https://','wss://')}/ws`);
  ws.binaryType = 'arraybuffer';

  ws.onopen = async ()=>{
    $('#status').textContent="å·²é€£ç·š / ì—°ê²°ë¨"; $('#status').classList.add('now');
    ws.send(JSON.stringify({name, src_lang: srcLang}));

    try{
      const devId = $('#micSel').value || undefined;
      const streamLocal = await getMicStream(devId);
      stream = streamLocal;
      const info = stream.getAudioTracks()[0]?.getSettings?.() || {};
      log(`ğŸ™ï¸ mic/ë§ˆì´í¬ï¼š${(stream.getAudioTracks()[0]?.label)||'æœªçŸ¥'} | è¨­å®šï¼š${JSON.stringify(info)}`);
    }catch(e){ log(`âŒ å–å¾—éº¥å…‹é¢¨å¤±æ•—ï¼š${e}`); return; }

    audioCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:48000});
    await audioCtx.resume().catch(()=>{});

    // Worklet â†’ fallback
    try{
      if (audioCtx.audioWorklet) {
        const blobURL = URL.createObjectURL(new Blob([`
          class ResampleWorklet extends AudioWorkletProcessor {
            constructor(){ super(); this.srcRate=sampleRate; this.dstRate=16000; }
            process(inputs){
              const i=inputs[0]; if(!i||!i[0]) return true;
              const x=i[0]; const ratio=this.srcRate/this.dstRate;
              const outLen=Math.floor(x.length/ratio);
              const pcm=new Int16Array(outLen);
              for(let k=0;k<outLen;k++){
                const pos=(k*ratio)|0; let s=x[pos];
                s=Math.max(-1,Math.min(1,s)); pcm[k]=s<0?s*0x8000:s*0x7FFF;
              }
              for(let off=0; off<pcm.length; off+=320){
                const sl=pcm.subarray(off, off+320);
                if(sl.length===320) this.port.postMessage(sl.buffer,[sl.buffer]);
              }
              return true;
            }
          }
          registerProcessor('resample-worklet', ResampleWorklet);
        `], {type:'application/javascript'}));
        await audioCtx.audioWorklet.addModule(blobURL);

        const source   = audioCtx.createMediaStreamSource(stream);
        const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0; // è‡ªå·±ç«¯æ°¸ä¹…ç„¡è²
        worklet = new AudioWorkletNode(audioCtx, 'resample-worklet');

        let sent=0;
        worklet.port.onmessage = (e)=>{
          sent++; txPkts++;
          if(!$('#mute').checked && ws && ws.readyState===1){
            ws.send(e.data);
          }
        };

        source.connect(worklet); worklet.connect(zeroGain); zeroGain.connect(audioCtx.destination);
        log(`âœ… Worklet å•Ÿç”¨ï¼ˆctxRate=${audioCtx.sampleRate}Hzï¼‰`);

        setTimeout(()=>{ if(sent===0){ log("âš ï¸ Worklet ç„¡é€åŒ…ï¼Œæ”¹ ScriptProcessor"); try{ worklet.disconnect(); }catch(_){ } fallbackScriptProcessor(source); } }, 700);
      } else {
        const source = audioCtx.createMediaStreamSource(stream);
        await fallbackScriptProcessor(source);
      }
    }catch(e){
      const source = audioCtx.createMediaStreamSource(stream);
      log(`âš ï¸ Worklet å¤±æ•—ï¼š${e}`);
      await fallbackScriptProcessor(source);
    }

    txTimer = setInterval(()=>{ $('#tx').textContent = `TX: ${txPkts} pkt/s`; txPkts=0; }, 1000);
    $('#join').disabled=true; $('#leave').disabled=false;
    pingTimer = setInterval(()=>{ try{ ws.send(JSON.stringify({type:"ping"})); }catch(_){ } }, 20000);
  };

  ws.onmessage = async (ev)=>{
    if(ev.data instanceof ArrayBuffer){
      // åªæœƒé€åˆ¥äººçš„è­¯éŸ³ MP3ï¼ˆè‡ªå·±æ°¸é æ”¶ä¸åˆ°è‡ªå·±çš„ MP3ï¼‰
      const buf = ev.data;
      const blob = new Blob([buf],{type:'audio/mpeg'});
      const url  = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.autoplay = true;
      if (typeof a.setSinkId === 'function' && $('#outSel').value){
        try { await a.setSinkId($('#outSel').value); } catch(e){ log(`âš ï¸ è¨­å®šè¼¸å‡ºå¤±æ•—ï¼š${e}`); }
      }
      a.onended = ()=>{ URL.revokeObjectURL(url); };
      a.play().catch(()=>{});
      return;
    }
    try{
      const o=JSON.parse(ev.data);
      if(o.type==="join")  log(`ğŸ”µ ${o.name} åŠ å…¥ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="leave") log(`âšª ${o.name} é›¢é–‹ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="final") log(`âœ… ${o.from}ï¼ˆ${o.dir}ï¼‰\nåŸæ–‡ï¼š${o.text}\nç¿»è­¯ï¼š${o.mt}`);
      if(o.type==="mute")  log(`ğŸ”‡ ${o.name} ${o.muted?"å·²éœéŸ³":"å–æ¶ˆéœéŸ³"}`);
      if(o.type==="error") log(`âŒ éŒ¯èª¤ï¼š${o.msg}`);
      if(o.type==="tts_info") log(`ğŸ§ MP3 bytes=${o.bytes} from ${o.from}`);

      // âš ï¸ å·²ç§»é™¤å°ç™¼è©±è€…çš„ tts_client æœ¬åœ°æœ—è®€ï¼ˆæœ¬äººæ°¸é ä¸æœ—è®€è‡ªå·±çš„è­¯æ–‡ï¼‰
      // è‹¥ä¼ºæœå™¨å‚³æ–‡å­—å‚™æ´çµ¦ã€Œå…¶ä»–äººã€ï¼Œæœ¬ç«¯ä¸æœƒæ”¶åˆ°ï¼›æ‰€ä»¥ä¸éœ€è™•ç† tts_textã€‚
    }catch(_){}
  };

  ws.onclose = ()=>{ log("é€£ç·šé—œé–‰"); leave(); };
}

$('#join').onclick = join;
$('#leave').onclick = leave;
$('#mute').onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'mute', value:$('#mute').checked})); };
$('#micSel').onchange = async ()=>{ currentMicId = $('#micSel').value || ""; await refreshDevices(); };
$('#outSel').onchange = ()=>{ currentOutId = $('#outSel').value || ""; };
navigator.mediaDevices.addEventListener('devicechange', refreshDevices);
(async ()=>{ try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch(_){ } await refreshDevices(); })();
</script>
</body>
</html>
