<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï¼ˆå–®æˆ¿ã€é‚Šèªªé‚Šæ’­ã€æœ¬åœ°æ¨¡å‹ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial;padding:20px;max-width:860px;margin:auto}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type=text]{padding:8px 10px;border:1px solid #ccc;border-radius:10px;min-width:180px}
  button{padding:8px 14px;border-radius:10px;border:1px solid #bbb;background:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .pill{padding:4px 10px;border-radius:999px;background:#efefef;font-size:12px}
  .logs{margin-top:12px;padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;height:320px;overflow:auto;font-size:14px;white-space:pre-wrap}
  .now{color:#1b7fbd}
</style>
<body>
  <h2>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï¼ˆå–®ä¸€æˆ¿é–“ï¼‰</h2>

  <div class="row">
    <label>åç¨±</label>
    <input id="name" type="text" placeholder="ä½ çš„åå­—">
    <button id="join">åŠ å…¥</button>
    <button id="leave" disabled>é›¢é–‹</button>
    <span class="pill" id="status">æœªé€£ç·š</span>
  </div>

  <div class="row" style="margin-top:10px">
    <label><input id="mute" type="checkbox"> å°è‡ªå·±ç¦éŸ³ï¼ˆä¸é€å‡ºéº¥å…‹é¢¨ï¼‰</label>
    <label><input id="playSelf" type="checkbox" checked> æ’­æ”¾è‡ªå·±çš„è­¯éŸ³</label>
    <label><input id="echo" type="checkbox" checked> å›è²æŠ‘åˆ¶</label>
    <label><input id="ns" type="checkbox" checked> é™å™ª</label>
    <label><input id="agc" type="checkbox" checked> è‡ªå‹•å¢ç›Š</label>
  </div>

  <div class="logs" id="logs"></div>

<script>
/* ä½ çš„ Cloudflare Tunnel ç¶²åŸŸï¼ˆæ¯æ¬¡è®Šå‹•å°±æ”¹é€™ä¸€è¡Œï¼‰ */
const TUNNEL_HOST = "https://seattle-substantially-period-sector.trycloudflare.com";

let ws=null, audioCtx=null, worklet=null, stream=null, pingTimer=null;
let playQueue=[], playing=false, joined=false;

const $  = (s)=>document.querySelector(s);
const log= (s)=>{ const el=$('#logs'); el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight; };

async function join(){
  if (joined) return;
  const name = $('#name').value.trim() || 'Guest';

  // å…ˆé€£ WSï¼Œå…ˆç™¼ helloï¼Œå†é–‹éº¥ï¼ˆé¿å…æ¡æ‰‹å‰å‚³äº† bytes å°è‡´ä¼ºæœå™¨é—œé–‰ï¼‰
  ws = new WebSocket(`wss://${TUNNEL_HOST}/ws`);
  ws.binaryType = 'arraybuffer';

  ws.onopen = async ()=>{
    $('#status').textContent="å·²é€£ç·š"; $('#status').classList.add('now');
    // 1) å…ˆé€ hello
    ws.send(JSON.stringify({name, play_self: $('#playSelf').checked}));

    // 2) å†é–‹éº¥ï¼Œç¢ºä¿æ¡æ‰‹å®Œæˆå¾Œæ‰æœƒé–‹å§‹é€ bytes
    stream = await navigator.mediaDevices.getUserMedia({
      audio:{
        channelCount:1, sampleRate:48000,
        echoCancellation: $('#echo').checked,
        noiseSuppression: $('#ns').checked,
        autoGainControl:  $('#agc').checked
      }
    });
    audioCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:48000});

    const blobURL = URL.createObjectURL(new Blob([`
      class PCMWorklet extends AudioWorkletProcessor {
        constructor(){ super(); this.srcRate=sampleRate; this.dstRate=16000; }
        process(inputs){
          const input=inputs[0]; if(!input||!input[0]) return true;
          const ch=input[0], ratio=this.srcRate/this.dstRate;
          const outLen=Math.floor(ch.length/ratio);
          const pcm=new Int16Array(outLen);
          for(let i=0;i<outLen;i++){
            const idx=Math.floor(i*ratio); let s=ch[idx];
            s=Math.max(-1,Math.min(1,s)); pcm[i]=s<0?s*0x8000:s*0x7FFF;
          }
          // åˆ‡ 20ms å°åŒ…ï¼ˆ320 samples@16kï¼‰
          const pkt=320;
          for(let off=0; off<pcm.length; off+=pkt){
            const sl=pcm.subarray(off, off+pkt);
            if(sl.length===pkt) this.port.postMessage(sl.buffer,[sl.buffer]);
          }
          return true;
        }
      }
      registerProcessor('pcm-worklet', PCMWorklet);
    `], {type:'application/javascript'}));
    await audioCtx.audioWorklet.addModule(blobURL);

    const source = audioCtx.createMediaStreamSource(stream);
    worklet = new AudioWorkletNode(audioCtx, 'pcm-worklet');
    worklet.port.onmessage = (e)=>{
      if(!$('#mute').checked && ws && ws.readyState===1){
        ws.send(e.data);
      }
    };
    source.connect(worklet); // ä¸æ¥ destinationï¼Œé¿å…è‡ªè½å›æˆ

    joined = true; $('#join').disabled=true; $('#leave').disabled=false;

    // keepaliveï¼ˆé¿å…æŸäº›ç¶²è·¯è¨­å‚™é–’ç½®é—œé–‰ï¼‰ï¼šæ¯ 20 ç§’ ping ä¸€æ¬¡
    pingTimer = setInterval(()=>{ try{ ws.send(JSON.stringify({type:"ping"})); }catch(_){ } }, 20000);
  };

  ws.onmessage = (ev)=>{
    if(ev.data instanceof ArrayBuffer){
      playQueue.push(ev.data);
      if(!playing) playNext();
      return;
    }
    try{
      const o=JSON.parse(ev.data);
      if(o.type==="join")   log(`ğŸ”µ ${o.name} åŠ å…¥ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="leave")  log(`âšª ${o.name} é›¢é–‹ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="mute")   log(`ğŸ”‡ ${o.name} ${o.muted?"å·²éœéŸ³":"å–æ¶ˆéœéŸ³"}`);
      if(o.type==="partial")log(`ğŸ“ ${o.from}ï¼ˆ${o.dir}ï¼‰\n${o.text}`);
      if(o.type==="simul")  log(`ğŸ§ ${o.from}ï¼ˆ${o.dir} é‚Šæ’­ï¼‰\næ–°å¢ï¼š${o.src_add}\nç¿»è­¯ï¼š${o.mt_add}`);
      if(o.type==="final")  log(`âœ… ${o.from}ï¼ˆ${o.dir} å®Œæ•´ï¼‰\nåŸæ–‡ï¼š${o.text}\nç¿»è­¯ï¼š${o.mt}`);
      if(o.type==="pong")   {/* keepalive ok */}
      if(o.type==="error")  log(`âŒ ${o.msg}`);
    }catch(_){}
  };

  ws.onclose = ()=>{
    log("é€£ç·šé—œé–‰");
    $('#status').textContent="æœªé€£ç·š"; $('#status').classList.remove('now');
    $('#join').disabled=false; $('#leave').disabled=true;
    cleanupAudio(); joined=false;
  };
}

function cleanupAudio(){
  try{ worklet && worklet.disconnect(); }catch(_){}
  try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ audioCtx && audioCtx.close(); }catch(_){}
  try{ clearInterval(pingTimer); }catch(_){}
  worklet=null; audioCtx=null; stream=null; pingTimer=null;
}

function leave(){
  if(ws){ try{ ws.close(); }catch(_){} }
  cleanupAudio();
  $('#join').disabled=false; $('#leave').disabled=true; joined=false;
}

async function playNext(){
  if(playQueue.length===0){ playing=false; return; }
  playing=true;
  const buf=playQueue.shift();
  const blob=new Blob([buf],{type:'audio/wav'});
  const url=URL.createObjectURL(blob);
  const a=new Audio(url);
  a.onended=()=>{ URL.revokeObjectURL(url); playNext(); };
  a.play().catch(()=>{ /* æŸäº›ç€è¦½å™¨éœ€å…ˆäº’å‹•æ‰å…è¨±è‡ªå‹•æ’­æ”¾ */ });
}

$('#join').onclick = join;
$('#leave').onclick = leave;
$('#mute').onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'mute', value:$('#mute').checked})); };
$('#playSelf').onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'play_self', value:$('#playSelf').checked})); };
</script>
</body>
</html>
