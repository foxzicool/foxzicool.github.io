<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï¼ˆå–®æˆ¿ã€é‚Šèªªé‚Šæ’­ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial;padding:20px;max-width:900px;margin:auto}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  input[type=text], select{padding:8px 10px;border:1px solid #ccc;border-radius:10px;min-width:180px}
  button{padding:8px 14px;border-radius:10px;border:1px solid #bbb;background:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .pill{padding:4px 10px;border-radius:999px;background:#efefef;font-size:12px}
  .logs{margin-top:12px;padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;height:340px;overflow:auto;font-size:14px;white-space:pre-wrap}
  .now{color:#1b7fbd}
  #meter{width:180px;height:10px;background:#eee;border-radius:6px;overflow:hidden}
  #bar{display:block;height:100%;width:0%;background:#4caf50}
</style>
<body>
  <h2>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï¼ˆå–®ä¸€æˆ¿é–“ï¼‰</h2>

  <div class="row">
    <label>åç¨±</label>
    <input id="name" type="text" placeholder="ä½ çš„åå­—">
    <button id="join">åŠ å…¥</button>
    <button id="leave" disabled>é›¢é–‹</button>
    <span class="pill" id="status">æœªé€£ç·š</span>
    <span class="pill" id="tx">TX: 0 pkt/s</span>
  </div>

  <div class="row">
    <strong>è¼¸å…¥ä¾†æºï¼š</strong>
    <label><input type="radio" name="mode" value="mic" checked> éº¥å…‹é¢¨</label>
    <label><input type="radio" name="mode" value="tab"> åˆ†é éŸ³è¨Šï¼ˆShare Tabï¼‰</label>
    <select id="inDevice"></select>
    <button id="refresh">åˆ·æ–°è£ç½®</button>
    <span id="meter" title="è¼¸å…¥éŸ³é‡"><span id="bar"></span></span>
  </div>

  <div class="row">
    <strong>æ’­æ”¾è¼¸å‡ºè£ç½®ï¼š</strong>
    <select id="outDevice"></select>
    <small>(é¸ã€ŒAirPods Stereoã€é¿å…è¢«åˆ‡å»å–‡å­)</small>
  </div>

  <div class="logs" id="logs"></div>

  <!-- å–®ä¸€éš±è—æ’­æ”¾å™¨ï¼Œé›†ä¸­æ§åˆ¶ setSinkId -->
  <audio id="player" hidden></audio>

<script>
/* æ›æˆä½ ç•¶å‰ cloudflared çš„ä¸»æ©Ÿåï¼ˆä¸è¦å« https://ï¼‰ */
const TUNNEL_HOST = "room-rug-submitted-invitations.trycloudflare.com";

let ws=null, audioCtx=null, stream=null, sourceNode=null, analyser=null, meterTimer=null;
let sinkNode=null, worklet=null, scriptProc=null;
let pingTimer=null, txTimer=null, playQueue=[], playing=false, joined=false;
let sentPkts = 0, lastPkts = 0;

const $  = (s)=>document.querySelector(s);
const log= (s)=>{ const el=$('#logs'); if(!el) return; el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight; };

async function enumerateDevices(){
  const devs = await navigator.mediaDevices.enumerateDevices();
  const inputs = devs.filter(d=>d.kind==='audioinput');
  const outputs= devs.filter(d=>d.kind==='audiooutput');

  const inSel = $('#inDevice');  if(inSel){ inSel.innerHTML='';
    inputs.forEach(d=>{
      const opt=document.createElement('option');
      opt.value=d.deviceId;
      opt.textContent=d.label || `éŸ³è¨Šè¼¸å…¥ (${d.deviceId.slice(0,6)})`;
      inSel.appendChild(opt);
    });
  }

  const outSel= $('#outDevice'); if(outSel){ outSel.innerHTML='';
    outputs.forEach(d=>{
      const opt=document.createElement('option');
      opt.value=d.deviceId;
      opt.textContent=d.label || `è¼¸å‡º (${d.deviceId.slice(0,6)})`;
      outSel.appendChild(opt);
    });
  }
}

function startTXCounter(){
  const txEl = $('#tx');
  txTimer = setInterval(()=>{
    const diff = sentPkts - lastPkts; lastPkts = sentPkts;
    if(txEl) txEl.textContent = `TX: ${diff} pkt/s`;
  }, 1000);
}
function stopTXCounter(){ try{ clearInterval(txTimer); }catch(_){ } txTimer=null; }

function startMeter(){
  if(!analyser) return;
  const buf = new Float32Array(analyser.fftSize);
  const bar = $('#bar');
  const tick = ()=>{
    if(!analyser) return;
    analyser.getFloatTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum += v*v; }
    const rms = Math.sqrt(sum/buf.length);
    const pct = Math.min(100, Math.round(rms*2000));
    if(bar) bar.style.width = pct + '%';
    meterTimer = requestAnimationFrame(tick);
  };
  tick();
}
function stopMeter(){
  try{ cancelAnimationFrame(meterTimer); }catch(_){}
  meterTimer=null;
  const bar = $('#bar'); if(bar) bar.style.width='0%';
}

/* â€”â€” å–éŸ³ï¼šéº¥å…‹é¢¨ï¼ˆé«˜å“è³ªâ†’å¤±æ•—é€€å›å¯¬é¬†ï¼‰ â€”â€” */
async function startMicInput(){
  const inSel = $('#inDevice');
  const deviceId = inSel && inSel.value ? inSel.value : undefined;

  const A = {
    audio:{
      deviceId: deviceId ? {exact:deviceId} : undefined,
      channelCount: {ideal: 2},
      sampleRate:   {ideal: 48000},
      echoCancellation: $('#echo')?.checked ?? true,
      noiseSuppression: $('#ns')?.checked ?? true,
      autoGainControl:  $('#agc')?.checked ?? true
    }
  };
  const B = { audio:{ deviceId: deviceId ? {exact:deviceId} : undefined } };

  try{
    stream = await navigator.mediaDevices.getUserMedia(A);
  }catch(e1){
    log('âš ï¸ é«˜å“è³ªå–éŸ³å¤±æ•—ï¼Œé€€å›å¯¬é¬†ç´„æŸï¼š'+e1);
    stream = await navigator.mediaDevices.getUserMedia(B);
  }

  validateAndReportStream('mic');
  await setupAudioGraph();
}

/* â€”â€” å–éŸ³ï¼šåˆ†é éŸ³è¨Šï¼ˆShare Tabï¼‰ â€”â€” */
async function startTabAudioInput(){
  const disp = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  const atrack = disp.getAudioTracks()[0];
  if(!atrack){
    alert('æ²’æœ‰å–å¾—åˆ†é éŸ³è¨Šã€‚è«‹é¸ã€Œåˆ†é ã€ä¸¦å‹¾é¸ã€Œåˆ†äº«éŸ³è¨Šã€ã€‚');
    throw new Error('no-tab-audio');
  }
  disp.getVideoTracks().forEach(t=>t.stop());
  stream = new MediaStream([atrack]);
  validateAndReportStream('tab');
  await setupAudioGraph();
}

/* â€”â€” æª¢æŸ¥ stream èˆ‡ trackï¼Œä¸¦å›å ±åƒæ•¸ï¼ˆä¸å†ç”¨ instanceofï¼‰ â€”â€” */
function validateAndReportStream(tag){
  if(!stream || typeof stream.getAudioTracks !== 'function'){
    throw new Error('stream ç¼ºå°‘ getAudioTracks');
  }
  const tracks = stream.getAudioTracks();
  if(!tracks || tracks.length===0) throw new Error('MediaStream æ²’æœ‰ audio track');
  const t = tracks[0], s = t.getSettings?.() || {};
  log(`ğŸ™ï¸ ${tag} è¼¸å…¥è£ç½®ï¼š${t.label||'(æœªçŸ¥)'} | è¨­å®šï¼š${JSON.stringify(s)}`);
}

/* â€”â€” å»ºç«‹éŸ³è¨Šè™•ç†ç®¡ç·šï¼ˆè‡ªå‹•åµæ¸¬æ¨£ç‡ï¼›è‹¥å¤±æ•—å‰‡é‡åŒ…è£ MediaStreamï¼‰ â€”â€” */
async function setupAudioGraph(){
  cleanupGraph();

  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  await audioCtx.resume?.();

  // æœ‰äº›æƒ…æ³ stream ä¸æ˜¯åŒä¸€ realm çš„ MediaStreamï¼Œå…ˆå˜—è©¦ç›´æ¥å»ºç«‹
  try{
    sourceNode = audioCtx.createMediaStreamSource(stream);
  }catch(e1){
    log('âš ï¸ createMediaStreamSource å¤±æ•—ï¼Œå˜—è©¦ä»¥æœ¬ realm é‡æ–°åŒ…è£ tracksï¼š'+e1);
    try{
      const tracks = (stream && typeof stream.getAudioTracks==='function') ? stream.getAudioTracks() : [];
      const ms2 = new MediaStream(tracks);
      sourceNode = audioCtx.createMediaStreamSource(ms2);
      stream = ms2; // ç”¨é‡åŒ…è£å¾Œçš„æµ
      log('â™»ï¸ å·²æˆåŠŸä»¥æœ¬ realm é‡æ–°åŒ…è£ MediaStream');
    }catch(e2){
      log('âŒ é‡æ–°åŒ…è£ä»å¤±æ•—ï¼š'+e2);
      throw e2;
    }
  }

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  sourceNode.connect(analyser);

  sinkNode = audioCtx.createGain();
  sinkNode.gain.value = 0.0;
  sinkNode.connect(audioCtx.destination);

  const ok = await tryInstallWorklet();
  setTimeout(()=>{
    if(sentPkts===0){
      log('âš ï¸ Worklet ä¼¼ä¹æ²’æœ‰é€åŒ…ï¼Œåˆ‡æ› ScriptProcessor å¾Œå‚™è·¯ç·š');
      tryInstallScriptProcessor();
    }
  }, 1200);

  startMeter();
}

/* â€”â€” Worklet è·¯ç·š â€”â€” */
async function tryInstallWorklet(){
  try{
    const blobURL = URL.createObjectURL(new Blob([`
      class PCMWorklet extends AudioWorkletProcessor {
        constructor(){ super(); this.dstRate=16000; }
        process(inputs, outputs){
          const input=inputs[0]; if(!input || input.length===0) return true;
          const ch0 = input[0] || new Float32Array(128);
          let mono;
          if(input.length>=2 && input[1]){
            const c1 = input[1]; mono = new Float32Array(ch0.length);
            for(let i=0;i<mono.length;i++){ mono[i] = 0.5*(ch0[i] + c1[i]); }
          }else mono = ch0;

          const ratio = sampleRate / this.dstRate;
          const outLen = Math.floor(mono.length/ratio);
          const pcm = new Int16Array(outLen);
          for(let i=0;i<outLen;i++){
            const idx=Math.floor(i*ratio); let s=mono[idx]||0;
            s=Math.max(-1,Math.min(1,s)); pcm[i]=s<0?s*0x8000:s*0x7FFF;
          }
          const pkt=320; // 20ms@16k
          for(let off=0; off<pcm.length; off+=pkt){
            const sl=pcm.subarray(off, off+pkt);
            if(sl.length===pkt) this.port.postMessage(sl.buffer,[sl.buffer]);
          }
          const out = outputs[0]; if(out && out[0]) out[0].fill(0);
          return true;
        }
      }
      registerProcessor('pcm-worklet', PCMWorklet);
    `], {type:'application/javascript'}));

    await audioCtx.audioWorklet.addModule(blobURL);
    worklet = new AudioWorkletNode(audioCtx, 'pcm-worklet', {
      numberOfInputs:1, numberOfOutputs:1, outputChannelCount:[1]
    });
    worklet.port.onmessage = (e)=>{
      const muteEl = $('#mute');
      if(muteEl && !muteEl.checked && ws && ws.readyState===1){
        ws.send(e.data); sentPkts++;
      }
    };
    sourceNode.connect(worklet);
    worklet.connect(sinkNode);
    log(`âœ… Worklet å·²å•Ÿç”¨ï¼ˆctxRate=${audioCtx.sampleRate}Hzï¼‰`);
    return true;
  }catch(e){
    log('âŒ å®‰è£ AudioWorklet å¤±æ•—ï¼š'+e);
    return false;
  }
}

/* â€”â€” ScriptProcessor å¾Œå‚™ â€”â€” */
function tryInstallScriptProcessor(){
  try{
    const ctxRate = audioCtx.sampleRate;
    scriptProc = audioCtx.createScriptProcessor(4096, 2, 1);
    scriptProc.onaudioprocess = (ev)=>{
      const ib = ev.inputBuffer;
      const ch0 = ib.getChannelData(0);
      const ch1 = ib.numberOfChannels>1 ? ib.getChannelData(1) : null;
      const mono = new Float32Array(ib.length);
      for(let i=0;i<mono.length;i++){
        const a = ch0[i]||0, b = ch1?ch1[i]:0;
        mono[i] = ch1 ? 0.5*(a+b) : a;
      }
      const ratio = ctxRate/16000;
      const outLen= Math.floor(mono.length/ratio);
      const pcm   = new Int16Array(outLen);
      for(let i=0;i<outLen;i++){
        const idx=Math.floor(i*ratio); let s=mono[idx]||0;
        s=Math.max(-1,Math.min(1,s)); pcm[i]=s<0?s*0x8000:s*0x7FFF;
      }
      const pkt=320;
      for(let off=0; off<pcm.length; off+=pkt){
        const sl=pcm.subarray(off, off+pkt);
        const muteEl = $('#mute');
        if(sl.length===pkt && muteEl && !muteEl.checked && ws && ws.readyState===1){
          ws.send(sl.buffer); sentPkts++;
        }
      }
    };
    sourceNode.connect(scriptProc);
    scriptProc.connect(sinkNode);
    log(`âœ… ScriptProcessor å·²å•Ÿç”¨ï¼ˆctxRate=${ctxRate}Hzï¼‰`);
  }catch(e){
    log('âŒ å®‰è£ ScriptProcessor å¤±æ•—ï¼š'+e);
  }
}

/* â€”â€” æ¸…ç†éŸ³è¨Šåœ– â€”â€” */
function cleanupGraph(){
  try{ worklet && worklet.disconnect(); }catch(_){}
  try{ scriptProc && scriptProc.disconnect(); }catch(_){}
  try{ sinkNode && sinkNode.disconnect(); }catch(_){}
  try{ sourceNode && sourceNode.disconnect(); }catch(_){}
  try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ audioCtx && audioCtx.close(); }catch(_){}
  stopMeter();
  worklet=scriptProc=sinkNode=sourceNode=analyser=null;
  audioCtx=null; stream=null;
}

/* â€”â€” æ’­æ”¾è¼¸å‡ºè£ç½®ï¼ˆAirPods Stereoï¼‰ â€”â€” */
async function setOutputSink(){
  const outSel = $('#outDevice');
  const player = $('#player');
  if(!outSel || !player) return;
  if(player.sinkId !== undefined && outSel.value){
    try{ await player.setSinkId(outSel.value); }
    catch(e){ log('âš ï¸ è¨­å®šè¼¸å‡ºè£ç½®å¤±æ•—ï¼š'+e); }
  }
}

/* â€”â€” é€£ç·š/äº‹ä»¶ â€”â€” */
async function join(){
  if (joined) return;
  const nameEl = $('#name'); const statusEl = $('#status');
  const playSelfEl = $('#playSelf');
  const modeEl = document.querySelector('input[name="mode"]:checked');
  if(!modeEl) { log('âŒ æ‰¾ä¸åˆ°è¼¸å…¥æ¨¡å¼æŒ‰éˆ•'); return; }

  const wsUrl = `wss://${TUNNEL_HOST}/ws`;
  console.log("WS URL =", wsUrl);
  ws = new WebSocket(wsUrl);
  ws.binaryType = 'arraybuffer';

  ws.onopen = async ()=>{
    if(statusEl){ statusEl.textContent="å·²é€£ç·š"; statusEl.classList.add('now'); }
    ws.send(JSON.stringify({name: (nameEl?.value?.trim()||'Guest'), play_self: !!(playSelfEl?.checked)}));

    try{
      if(modeEl.value==='tab') await startTabAudioInput();
      else await startMicInput();
    }catch(e){
      log('âŒ ç„¡æ³•å•Ÿå‹•éŸ³æºï¼š' + e);
      return;
    }

    await setOutputSink();

    joined = true;
    const joinBtn=$('#join'), leaveBtn=$('#leave');
    if(joinBtn) joinBtn.disabled = true;
    if(leaveBtn) leaveBtn.disabled = false;

    pingTimer = setInterval(()=>{ try{ ws.send(JSON.stringify({type:"ping"})); }catch(_){ } }, 20000);
    startTXCounter();

    enumerateDevices().catch(()=>{});
  };

  ws.onmessage = (ev)=>{
    if(ev.data instanceof ArrayBuffer){ queuePlay(ev.data); return; }
    try{
      const o=JSON.parse(ev.data);
      if(o.type==="join")   log(`ğŸ”µ ${o.name} åŠ å…¥ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="leave")  log(`âšª ${o.name} é›¢é–‹ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="mute")   log(`ğŸ”‡ ${o.name} ${o.muted?"å·²éœéŸ³":"å–æ¶ˆéœéŸ³"}`);
      if(o.type==="partial")log(`ğŸ“ ${o.from}ï¼ˆ${o.dir}ï¼‰\n${o.text}`);
      if(o.type==="simul")  log(`ğŸ§ ${o.from}ï¼ˆ${o.dir} é‚Šæ’­ï¼‰\næ–°å¢ï¼š${o.src_add}\nç¿»è­¯ï¼š${o.mt_add}`);
      if(o.type==="final")  log(`âœ… ${o.from}ï¼ˆ${o.dir} å®Œæ•´ï¼‰\nåŸæ–‡ï¼š${o.text}\nç¿»è­¯ï¼š${o.mt}`);
      if(o.type==="stat")   log(`ğŸ“¶ ${o.from} ä¸Šè¡Œ: ${o.rx_frames} frames`);
      if(o.type==="error")  log(`âŒ ${o.msg}`);
    }catch(_){}
  };

  ws.onclose = ()=>{
    log("é€£ç·šé—œé–‰");
    if(statusEl){ statusEl.textContent="æœªé€£ç·š"; statusEl.classList.remove('now'); }
    const joinBtn=$('#join'), leaveBtn=$('#leave');
    if(joinBtn) joinBtn.disabled=false;
    if(leaveBtn) leaveBtn.disabled=true;
    cleanup(); joined=false;
  };
}

function cleanup(){
  cleanupGraph();
  try{ clearInterval(pingTimer); }catch(_){}
  stopTXCounter();
  pingTimer=null;
}

function leave(){
  if(ws){ try{ ws.close(); }catch(_){} }
  cleanup();
  const joinBtn=$('#join'), leaveBtn=$('#leave');
  if(joinBtn) joinBtn.disabled=false;
  if(leaveBtn) leaveBtn.disabled=true;
  joined=false;
}

/* â€”â€” æ’­æ”¾ä½‡åˆ—ï¼ˆç¶å®š setSinkIdï¼‰ â€”â€” */
async function queuePlay(arrayBuf){
  const blob = new Blob([arrayBuf], {type:'audio/wav'});
  const url  = URL.createObjectURL(blob);
  playQueue.push(url);
  if(!playing) playNext();
}
async function playNext(){
  if(playQueue.length===0){ playing=false; return; }
  playing=true;
  const url = playQueue.shift();
  const player = $('#player');
  if(!player){ playing=false; return; }
  await setOutputSink();
  player.src = url;
  player.onended = ()=>{ URL.revokeObjectURL(url); playNext(); };
  player.play().catch(e=>{ log('âš ï¸ è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹ï¼Œè«‹é»ä¸€ä¸‹é é¢ï¼š'+e); });
}

/* åªåœ¨ DOM çœŸçš„æº–å‚™å¥½ä¹‹å¾Œæ‰ç¶äº‹ä»¶ */
window.addEventListener('DOMContentLoaded', ()=>{
  const joinBtn=$('#join'), leaveBtn=$('#leave'), refreshBtn=$('#refresh');
  const muteEl=$('#mute'), playSelfEl=$('#playSelf'), outSel=$('#outDevice');

  if(joinBtn) joinBtn.onclick = join;
  if(leaveBtn) leaveBtn.onclick = leave;
  if(refreshBtn) refreshBtn.onclick = async ()=>{
    try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch(_){}
    await enumerateDevices();
  };
  if(muteEl) muteEl.onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'mute', value:!!muteEl.checked})); };
  if(playSelfEl) playSelfEl.onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'play_self', value:!!playSelfEl.checked})); };
  if(outSel) outSel.onchange = ()=> setOutputSink();

  // åˆå§‹åˆ—è£ç½®ï¼›æ’æ‹”è€³æ©Ÿæ™‚è‡ªå‹•åˆ·æ–°
  enumerateDevices().catch(()=>{});
  navigator.mediaDevices.addEventListener?.('devicechange', ()=> enumerateDevices().catch(()=>{}));
});
</script>
</body>
</html>
