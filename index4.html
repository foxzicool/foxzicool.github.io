<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>中↔韓 同聲傳譯（完整句｜本地監聽自己 + 伺服器播譯音）</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial;padding:20px;max-width:900px;margin:auto}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button{padding:8px 10px;border:1px solid #bbb;border-radius:10px;background:#fff}
  button{cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .pill{padding:4px 10px;border-radius:999px;background:#efefef;font-size:12px}
  .logs{margin-top:12px;padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;height:380px;overflow:auto;font-size:14px;white-space:pre-wrap}
  .now{color:#1b7fbd}
  .stat{font-family:monospace}
  .hint{color:#666;font-size:13px}
  label.inline{display:inline-flex;align-items:center;gap:6px}
</style>
<body>
  <h2>中↔韓 同聲傳譯（完整句｜本地監聽自己 + 伺服器播譯音）</h2>

  <div class="row">
    <label>名稱(이름)</label>
    <input id="name" type="text" placeholder="你的名字(이름)" value="Public">
    <label>來源語言(원어)</label>
    <select id="srcLang">
      <option value="zh" selected>中文（強制）</option>
      <option value="ko">韓文（強制）</option>
    </select>
    <button id="join">加入(입장)</button>
    <button id="leave" disabled>離開(나가기)</button>
    <span class="pill" id="status">未連線</span>
  </div>

  <div class="row" style="margin-top:10px">
    <label class="inline"><input id="mute" type="checkbox"> 不送出麥克風</label>
    <label class="inline"><input id="echo" type="checkbox" checked> 回聲抑制</label>
    <label class="inline"><input id="ns" type="checkbox" checked> 降噪</label>
    <label class="inline"><input id="agc" type="checkbox" checked> 自動增益</label>
    <span class="stat" id="tx">TX: 0 pkt/s</span>
  </div>

  <div class="row" style="margin-top:10px">
    <label for="micSel">輸入裝置(마이크)</label>
    <select id="micSel"></select>
    <label class="inline">
      <input id="monitor" type="checkbox" checked>
      本地回聽自己
    </label>
    <label class="inline">音量
      <input id="monVol" type="range" min="0" max="1" step="0.01" value="0.9">
    </label>
    <span class="hint">建議戴耳機，避免回授。</span>
  </div>

  <div class="logs" id="logs"></div>

<script>
const TUNNEL_HOST = "https://twenty-chose-src-keeps.trycloudflare.com";

let ws=null, audioCtx=null, workletNode=null, stream=null, pingTimer=null, txTimer=null;
let playQueue=[], playing=false, joined=false, txPkts=0;
let monitorGain=null, micSource=null;

const $  = (s)=>document.querySelector(s);
const log= (s)=>{ const el=$('#logs'); el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight; };

async function listMics(){
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const mics = devs.filter(d=>d.kind==="audioinput");
    const sel = $('#micSel'); sel.innerHTML="";
    mics.forEach(d=>{
      const opt=document.createElement('option');
      opt.value=d.deviceId; opt.textContent=d.label || `麥克風 (${d.deviceId.slice(0,6)}…)`;
      sel.appendChild(opt);
    });
  }catch(e){ log(`❌ 裝置列舉失敗：${e}`); }
}

async function getMicStream(deviceId){
  const cts = {
    audio:{
      deviceId: deviceId ? {exact: deviceId} : undefined,
      channelCount:1, sampleRate:48000, sampleSize:16,
      echoCancellation: $('#echo').checked,
      noiseSuppression: $('#ns').checked,
      autoGainControl:  $('#agc').checked
    }
  };
  return await navigator.mediaDevices.getUserMedia(cts);
}

function cleanupAudio(){
  try{ workletNode && workletNode.disconnect(); }catch(_){}
  try{ monitorGain && monitorGain.disconnect(); }catch(_){}
  try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ audioCtx && audioCtx.close(); }catch(_){}
  try{ clearInterval(pingTimer); }catch(_){}
  try{ clearInterval(txTimer); }catch(_){}
  workletNode=null; monitorGain=null; micSource=null;
  audioCtx=null; stream=null; pingTimer=null; txTimer=null; txPkts=0;
}

function leave(){
  if(ws){ try{ ws.close(); }catch(_){} }
  cleanupAudio();
  $('#join').disabled=false; $('#leave').disabled=true; joined=false;
  $('#status').textContent="未連線"; $('#status').classList.remove('now');
}

async function setupLocalMonitor(){
  monitorGain = audioCtx.createGain();
  monitorGain.gain.value = $('#monitor').checked ? Number($('#monVol').value) : 0.0;
  micSource.connect(monitorGain).connect(audioCtx.destination);
}

async function join(){
  if (joined) return;
  await listMics();

  const name = ($('#name').value || 'Guest').trim().slice(0,40);
  const srcLang = $('#srcLang').value;

  ws = new WebSocket(`${TUNNEL_HOST.replace('https://','wss://')}/ws`);
  ws.binaryType = 'arraybuffer';

  ws.onopen = async ()=>{
    $('#status').textContent="已連線"; $('#status').classList.add('now');
    ws.send(JSON.stringify({name, src_lang: srcLang}));

    try{
      const devId = $('#micSel').value || undefined;
      stream = await getMicStream(devId);
      const info = stream.getAudioTracks()[0]?.getSettings?.() || {};
      log(`🎙️ mic：${(stream.getAudioTracks()[0]?.label)||'未知'} | 設定：${JSON.stringify(info)}`);
    }catch(e){ log(`❌ 取得麥克風失敗：${e}`); return; }

    audioCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:48000});
    await audioCtx.resume().catch(()=>{});

    micSource = audioCtx.createMediaStreamSource(stream);

    // === 本地監聽（零延遲原音） ===
    await setupLocalMonitor();

    // === 上行壓縮：48k -> 16k、20ms 封包 ===
    try{
      if (audioCtx.audioWorklet) {
        const blobURL = URL.createObjectURL(new Blob([`
          class PCMWorklet extends AudioWorkletProcessor {
            constructor(){ super(); this.srcRate=sampleRate; this.dstRate=16000; }
            process(inputs){
              const input=inputs[0]; if(!input||!input[0]) return true;
              const ch=input[0], ratio=this.srcRate/this.dstRate;
              const outLen=Math.floor(ch.length/ratio);
              const pcm=new Int16Array(outLen);
              for(let i=0;i<outLen;i++){
                const idx=Math.floor(i*ratio); let s=ch[idx];
                s=Math.max(-1,Math.min(1,s)); pcm[i]=s<0?s*0x8000:s*0x7FFF;
              }
              const pkt=320; // 20ms@16k
              for(let off=0; off<pcm.length; off+=pkt){
                const sl=pcm.subarray(off, off+pkt);
                if(sl.length===pkt) this.port.postMessage(sl.buffer,[sl.buffer]);
              }
              return true;
            }
          }
          registerProcessor('pcm-worklet', PCMWorklet);
        `], {type:'application/javascript'}));
        await audioCtx.audioWorklet.addModule(blobURL);
        workletNode = new AudioWorkletNode(audioCtx, 'pcm-worklet');
        workletNode.port.onmessage = (e)=>{
          txPkts++;
          if(!$('#mute').checked && ws && ws.readyState===1){
            ws.send(e.data);
          }
        };
        micSource.connect(workletNode); // 只為取樣打包；本地監聽已由 monitorGain 完成
        log(`✅ Worklet 已啟用（ctxRate=${audioCtx.sampleRate}Hz）`);
      } else {
        // Fallback：ScriptProcessor
        const sp = audioCtx.createScriptProcessor(2048, 1, 1);
        sp.onaudioprocess = (ev)=>{
          const ch = ev.inputBuffer.getChannelData(0);
          const ratio = 3; // 48k -> 16k
          const outLen = Math.floor(ch.length/ratio);
          const pcm = new Int16Array(outLen);
          for(let i=0;i<outLen;i++){
            let s = ch[i*ratio];
            s=Math.max(-1,Math.min(1,s)); pcm[i] = s<0 ? s*0x8000 : s*0x7FFF;
          }
          const pkt=320;
          for(let off=0; off<pcm.length; off+=pkt){
            const sl=pcm.subarray(off, off+pkt);
            if(sl.length===pkt){
              txPkts++;
              if(!$('#mute').checked && ws && ws.readyState===1){
                ws.send(sl.buffer);
              }
            }
          }
        };
        micSource.connect(sp); // 不接到 destination，避免重複；本地監聽走 monitorGain
        log(`✅ ScriptProcessor 已啟用（ctxRate=${audioCtx.sampleRate}Hz）`);
      }
    }catch(e){
      log(`⚠️ 上行編碼節點錯誤：${e}`);
    }

    txTimer = setInterval(()=>{ $('#tx').textContent = `TX: ${txPkts} pkt/s`; txPkts=0; }, 1000);
    joined = true; $('#join').disabled=true; $('#leave').disabled=false;
    pingTimer = setInterval(()=>{ try{ ws.send(JSON.stringify({type:"ping"})); }catch(_){ } }, 20000);
  };

  ws.onmessage = (ev)=>{
    if(ev.data instanceof ArrayBuffer){
      // 後端現在：原音(WAV)不會回給自己；譯音(MP3)所有人都會收到
      playQueue.push(ev.data);
      if(!playing) playNext();
      return;
    }
    try{
      const o=JSON.parse(ev.data);
      if(o.type==="join")    log(`🔵 ${o.name} 加入，人數 ${o.count}`);
      if(o.type==="leave")   log(`⚪ ${o.name} 離開，人數 ${o.count}`);
      if(o.type==="final")   log(`✅ ${o.from}（${o.dir}）\n原文：${o.text}\n翻譯：${o.mt}`);
      if(o.type==="mute")    log(`🔇 ${o.name} ${o.muted?"已靜音":"取消靜音"}`);
      if(o.type==="error")   log(`❌ ${o.msg}`);
    }catch(_){}
  };

  ws.onclose = ()=>{ log("連線關閉"); leave(); };
}

function sniffMime(buf){
  if (buf.byteLength >= 12){
    const dv = new DataView(buf);
    const riff = String.fromCharCode(dv.getUint8(0),dv.getUint8(1),dv.getUint8(2),dv.getUint8(3));
    const wave = String.fromCharCode(dv.getUint8(8),dv.getUint8(9),dv.getUint8(10),dv.getUint8(11));
    if (riff === 'RIFF' && wave === 'WAVE') return 'audio/wav';
  }
  return 'audio/mpeg';
}

async function playNext(){
  if(playQueue.length===0){ playing=false; return; }
  playing=true;
  const buf=playQueue.shift();
  const mime = sniffMime(buf); // MP3 主要是譯音；WAV 是別人的原音
  const blob=new Blob([buf],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=new Audio(url);
  a.onended=()=>{ URL.revokeObjectURL(url); playNext(); };
  a.play().catch(()=>{ /* 某些瀏覽器需要互動才自動播放 */ });
}

$('#join').onclick = join;
$('#leave').onclick = leave;
$('#mute').onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'mute', value:$('#mute').checked})); };
$('#monitor').onchange = ()=>{ if(monitorGain){ monitorGain.gain.value = $('#monitor').checked ? Number($('#monVol').value) : 0.0; } };
$('#monVol').oninput   = ()=>{ if(monitorGain){ monitorGain.gain.value = $('#monitor').checked ? Number($('#monVol').value) : 0.0; } };

navigator.mediaDevices.addEventListener('devicechange', listMics);
listMics();
</script>
</body>
</html>
