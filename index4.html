<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï½œåªæ’­è­¯éŸ³çµ¦å…¶ä»–äººï¼ˆé˜²å›å‚³éˆï½œ4060 åŠ é€Ÿï¼‰</title>

<style>
  :root{
    --bg: #0b1220; --bg2:#0e1830; --card:#0f1b33cc; --muted:#8aa0c2; --text:#e9f0ff;
    --primary:#6aa7ff; --primary-2:#7be2ff; --accent:#c9f27b; --danger:#ff6b6b; --ok:#75e0a2;
    --ring:#213454; --border:#20304a; --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 16px;
  }
  body{
    margin:0; min-height:100vh; color:var(--text);
    font-family:ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "Microsoft JhengHei", Segoe UI, Roboto, Arial;
    background:
      radial-gradient(1200px 600px at 10% -10%, #264b9a33, transparent 60%),
      radial-gradient(1000px 500px at 110% 10%, #1a7fb833, transparent 60%),
      linear-gradient(180deg, var(--bg), var(--bg2));
  }
  .wrap{ max-width:1080px; margin:0 auto; padding:28px 18px 40px; }
  .hero{ display:flex; align-items:center; gap:14px; margin-bottom:18px; }
  .logo{ width:42px; height:42px; border-radius:12px;
    background: conic-gradient(from 220deg, var(--primary), var(--primary-2), var(--accent), var(--primary));
    box-shadow: 0 0 0 6px #6aa7ff22, var(--shadow); }
  h2{ margin:0; font-size:22px; letter-spacing:.3px; }
  .subtitle{ color:var(--muted); font-size:13px; margin-top:2px; }

  .card{ background: var(--card); backdrop-filter: blur(10px); border:1px solid var(--border);
    border-radius: var(--radius); box-shadow: var(--shadow); padding:18px; }

  .grid{ display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); align-items:center; }
  .col-2{grid-column:span 2}.col-3{span:3}.col-4{span:4}.col-5{span:5}.col-6{span:6}.col-12{span:12}
  @media (max-width: 880px){ .grid>*{ grid-column: span 12 !important; } }

  label{ font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }
  input[type="text"], select{
    width:100%; padding:10px 12px; background:#0b1730; color:var(--text);
    border:1px solid var(--ring); border-radius:12px; outline:none;
    transition: box-shadow .2s, border-color .2s;
  }
  input[type="text"]:focus, select:focus{ border-color: var(--primary); box-shadow: 0 0 0 4px #6aa7ff22; }

  .switches{ display:flex; flex-wrap:wrap; gap:12px 18px; align-items:center; }
  .switches label{ display:flex; align-items:center; gap:8px; margin:0; }
  .switches input[type="checkbox"]{ inline-size:18px; block-size:18px; accent-color: var(--primary); }

  .btns{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  button{
    border:1px solid var(--ring); color:var(--text); background:#0b1730; padding:10px 14px; border-radius:12px;
    cursor:pointer; transition:transform .05s, box-shadow .2s, border-color .2s, background .2s;
  }
  button:active{ transform: translateY(1px); } button[disabled]{ opacity:.5; cursor:not-allowed; }
  .btn-primary{ background: linear-gradient(180deg, #6aa7ff, #5b8ffb); border-color:#6aa7ffcc; color:#0b1220; font-weight:700; }
  .btn-danger{ background: linear-gradient(180deg, #ff7b7b, #ff6262); border-color:#ff9a9a; color:#1a0c0c; font-weight:700; }

  .status{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--ring);
    background:#0b1730; color:var(--muted); display:inline-flex; align-items:center; gap:8px; }
  .dot{ width:8px; height:8px; border-radius:50%; background:#8aa0c2; box-shadow: 0 0 0 4px #8aa0c210; }
  .now .dot{ background: var(--ok); box-shadow: 0 0 0 4px #75e0a220; } .now{ color:var(--ok)!important; border-color:#2d5a4a; }

  .tx{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#cfe2ff; background:#0b1730;
    padding:6px 10px; border-radius:10px; border:1px solid var(--ring); }

  .logs{ margin-top:16px; padding:14px 14px 18px; border:1px solid var(--ring); border-radius:14px;
    background: radial-gradient(400px 180px at 10% -10%, #6aa7ff10, transparent 50%), #071226;
    height:390px; overflow:auto; font-size:13.5px; line-height:1.6; box-shadow: inset 0 0 0 1px #ffffff05, var(--shadow);
    white-space:pre-wrap; }
  .logs::-webkit-scrollbar{ width:10px; height:10px; }
  .logs::-webkit-scrollbar-thumb{ background: linear-gradient(180deg, #3a5f9d, #2d4e86); border-radius:10px; border:2px solid #0b1220; }

  .hint{ color:var(--muted); font-size:12px; }
</style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h2>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï¼ˆåªæ’­è­¯éŸ³çµ¦å…¶ä»–äººï½œä¸å›å‚³çµ¦ç™¼è©±è€…ï¼‰</h2>
        <div class="subtitle">æœçµ•ã€Œä¸­â†’éŸ“â†’ä¸­ã€å›å‚³éˆï½œ4060 åŠ é€Ÿï½œAirPods/è£ç½®åˆ‡æ›æ”¯æ´</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="grid">
        <div class="col-4">
          <label for="name">åç¨±(ì´ë¦„)</label>
          <input id="name" type="text" value="Public" placeholder="ä½ çš„åå­— / ì´ë¦„" />
        </div>
        <div class="col-3">
          <label for="srcLang">ä¾†æºèªè¨€(ì›ì–´)</label>
          <select id="srcLang">
            <option value="zh" selected>ä¸­æ–‡ (ì¤‘êµ­ì–´)</option>
            <option value="ko">éŸ“æ–‡ (í•œêµ­ì–´)</option>
          </select>
        </div>
        <div class="col-5">
          <label>é€£ç·š(ì—°ê²°)</label>
          <div class="btns">
            <button id="join" class="btn-primary">åŠ å…¥(ì…ì¥)</button>
            <button id="leave" class="btn-danger" disabled>é›¢é–‹(ë‚˜ê°€ê¸°)</button>
            <span id="status" class="status"><span class="dot"></span> æœªé€£ç·š(ë¯¸ì—°ê²°)</span>
            <span class="tx" id="tx">TX: 0 pkt/s</span>
          </div>
        </div>
        <div class="col-12">
          <div class="switches">
            <label><input id="mute" type="checkbox"> ä¸é€å‡ºéº¥å…‹é¢¨(ë§ˆì´í¬ ì „ì†¡ ì•ˆ í•¨)</label>
            <label><input id="echo" type="checkbox" checked> å›è²æŠ‘åˆ¶(ì—ì½” ì œê±°)</label>
            <label><input id="ns"   type="checkbox" checked> é™å™ª(ì†ŒìŒ ì–µì œ)</label>
            <label><input id="agc"  type="checkbox"> è‡ªå‹•å¢ç›Š(ìë™ ì´ë“)</label>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div class="col-6">
          <label for="micSel">è¼¸å…¥è£ç½®(ë§ˆì´í¬)</label>
          <select id="micSel"></select>
        </div>
        <div class="col-6">
          <label for="outSel">è¼¸å‡ºè£ç½®(ì¶œë ¥, MP3)</label>
          <select id="outSel"></select>
        </div>
        <div class="col-12">
          <div class="hint">ç³»çµ±åªæ’­æ”¾ã€Œè­¯éŸ³ MP3ã€ï¼Œæ°¸ä¸æ’­æ”¾ã€ŒåŸéŸ³ WAVã€ã€‚æ’­æ”¾æœŸé–“æœƒæš«åœé€å‡ºéº¥å…‹é¢¨ï¼Œé¿å…å›å‚³éˆã€‚</div>
        </div>
      </div>

      <div class="logs" id="logs"></div>
    </div>
  </div>

<script>
/* æ›æˆ cloudflared é¡¯ç¤ºçš„ç¶²å€ï¼ˆå« https://ï¼‰ */
const TUNNEL_HOST = "https://port-yea-myrtle-lib.trycloudflare.com";

let ws=null, audioCtx=null, worklet=null, sp=null, stream=null, pingTimer=null, txTimer=null;
let txPkts=0;

let devicesCache=[]; let currentMicId=""; let currentOutId="";
const $ = (s)=>document.querySelector(s);
const log = (s)=>{ const el=$('#logs'); el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight; };

/* æ’­æ”¾æŠ‘åˆ¶ï¼ˆDuckingï¼‰ï¼šæ’­æ”¾ä»–äººéŸ³è¨Šæ™‚æš«åœé€éº¥ï¼Œé¿å…ã€Œä¸­â†’éŸ“â†’ä¸­ã€å›å‚³éˆ */
let playbackCount = 0;
let lastPlaybackEndAt = 0;
const SUPPRESS_TAIL_MS = 250;
function micSuppressed(){
  return $('#mute').checked || playbackCount>0 || (performance.now() - lastPlaybackEndAt) < SUPPRESS_TAIL_MS;
}

async function refreshDevices(){
  devicesCache = await navigator.mediaDevices.enumerateDevices();
  const mics = devicesCache.filter(d=>d.kind==="audioinput");
  const outs = devicesCache.filter(d=>d.kind==="audiooutput");
  const micSel=$('#micSel'); micSel.innerHTML="";
  mics.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label || `éº¥å…‹é¢¨/ë§ˆì´í¬ (${d.deviceId.slice(0,6)}â€¦)`; micSel.appendChild(o); });
  const outSel=$('#outSel'); outSel.innerHTML="";
  outs.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label || `è¼¸å‡º/ì¶œë ¥ (${d.deviceId.slice(0,6)}â€¦)`; outSel.appendChild(o); });
  if (currentMicId && [...micSel.options].some(o=>o.value===currentMicId)) micSel.value=currentMicId;
  if (currentOutId && [...outSel.options].some(o=>o.value===currentOutId)) outSel.value=currentOutId;
}

async function getMicStream(deviceId){
  const cts = {
    audio:{
      deviceId: deviceId ? {exact: deviceId} : undefined,
      channelCount:{ideal:1}, sampleRate:{ideal:48000}, sampleSize:{ideal:16},
      echoCancellation:{ideal: $('#echo').checked},
      noiseSuppression:{ideal: $('#ns').checked},
      autoGainControl:{ideal: $('#agc').checked}
    }
  };
  return await navigator.mediaDevices.getUserMedia(cts);
}

function cleanupAudio(){
  try{ worklet && worklet.disconnect(); }catch(_){}
  try{ sp && sp.disconnect(); }catch(_){}
  try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ audioCtx && audioCtx.close(); }catch(_){}
  try{ clearInterval(pingTimer); }catch(_){}
  try{ clearInterval(txTimer); }catch(_){}
  worklet=sp=null; audioCtx=null; stream=null; pingTimer=txTimer=null; txPkts=0;
}
function leave(){
  if(ws){ try{ ws.close(); }catch(_){} }
  cleanupAudio();
  $('#join').disabled=false; $('#leave').disabled=true;
  const s=$('#status'); s.classList.remove('now'); s.innerHTML='<span class="dot"></span> æœªé€£ç·š(ë¯¸ì—°ê²°)';
}

async function fallbackScriptProcessor(source){
  const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0;
  sp = audioCtx.createScriptProcessor(2048,1,1);
  sp.onaudioprocess = (ev)=>{
    const ch=ev.inputBuffer.getChannelData(0);
    const ratio=48000/16000;
    const outLen=Math.floor(ch.length/ratio);
    const pcm=new Int16Array(outLen);
    for(let i=0;i<outLen;i++){
      const idx=(i*ratio)|0; let s=ch[idx];
      if(s>1) s=1; if(s<-1) s=-1;
      pcm[i]=s<0?s*0x8000:s*0x7FFF;
    }
    const pkt=320;
    for(let off=0; off<pcm.length; off+=pkt){
      const sl=pcm.subarray(off, off+pkt);
      if(sl.length===pkt){
        if(!micSuppressed() && ws && ws.readyState===1){
          ws.send(sl.buffer);
          txPkts++;
        }
      }
    }
  };
  source.connect(sp); sp.connect(zeroGain); zeroGain.connect(audioCtx.destination);
  log(`âœ… ScriptProcessor å•Ÿç”¨(ì‚¬ìš©)ï¼ˆctxRate=${audioCtx.sampleRate}Hzï¼‰`);
}

async function join(){
  try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch(_){}
  await refreshDevices();

  const name = ($('#name').value || 'Guest').trim().slice(0,40);
  const srcLang = $('#srcLang').value;

  ws = new WebSocket(`${TUNNEL_HOST.replace('https://','wss://')}/ws`);
  ws.binaryType = 'arraybuffer';

  ws.onopen = async ()=>{
    const s=$('#status'); s.classList.add('now'); s.innerHTML='<span class="dot"></span> å·²é€£ç·š(ì—°ê²°ë¨)';
    ws.send(JSON.stringify({name, src_lang: srcLang}));

    try{
      const devId = $('#micSel').value || undefined;
      stream = await getMicStream(devId);
      const info = stream.getAudioTracks()[0]?.getSettings?.() || {};
      log(`ğŸ™ï¸ micï¼š${(stream.getAudioTracks()[0]?.label)||'æœªçŸ¥/ì•Œ ìˆ˜ ì—†ìŒ'} | è¨­å®š/ì„¤ì •ï¼š${JSON.stringify(info)}`);
    }catch(e){ log(`âŒ å–å¾—éº¥å…‹é¢¨å¤±æ•—(ë§ˆì´í¬ ì‹¤íŒ¨)ï¼š${e}`); return; }

    audioCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:48000});
    await audioCtx.resume().catch(()=>{});

    try{
      if (audioCtx.audioWorklet) {
        const blobURL = URL.createObjectURL(new Blob([`
          class ResampleWorklet extends AudioWorkletProcessor {
            constructor(){ super(); this.srcRate=sampleRate; this.dstRate=16000; }
            process(inputs){
              const i=inputs[0]; if(!i||!i[0]) return true;
              const x=i[0]; const ratio=this.srcRate/this.dstRate;
              const outLen=Math.floor(x.length/ratio);
              const pcm=new Int16Array(outLen);
              for(let k=0;k<outLen;k++){
                const pos=(k*ratio)|0; let s=x[pos];
                s=Math.max(-1,Math.min(1,s)); pcm[k]=s<0?s*0x8000:s*0x7FFF;
              }
              for(let off=0; off<pcm.length; off+=320){
                const sl=pcm.subarray(off, off+320);
                if(sl.length===320) this.port.postMessage(sl.buffer,[sl.buffer]);
              }
              return true;
            }
          }
          registerProcessor('resample-worklet', ResampleWorklet);
        `], {type:'application/javascript'}));
        await audioCtx.audioWorklet.addModule(blobURL);

        const source   = audioCtx.createMediaStreamSource(stream);
        const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0;
        worklet = new AudioWorkletNode(audioCtx, 'resample-worklet');

        let sent=0;
        worklet.port.onmessage = (e)=>{
          if(!micSuppressed() && ws && ws.readyState===1){
            ws.send(e.data); txPkts++; sent++;
          }
        };

        source.connect(worklet); worklet.connect(zeroGain); zeroGain.connect(audioCtx.destination);
        log(`âœ… Worklet å•Ÿç”¨(ì‚¬ìš©)ï¼ˆctxRate=${audioCtx.sampleRate}Hzï¼‰`);

        setTimeout(()=>{ if(sent===0){ log("âš ï¸ Worklet ç„¡é€åŒ…(ì „ì†¡ ç„¡)ï¼Œæ”¹ ScriptProcessor"); try{ worklet.disconnect(); }catch(_){ } fallbackScriptProcessor(source); } }, 700);
      } else {
        const source = audioCtx.createMediaStreamSource(stream);
        await fallbackScriptProcessor(source);
      }
    }catch(e){
      const source = audioCtx.createMediaStreamSource(stream);
      log(`âš ï¸ Worklet å¤±æ•—(ì‹¤íŒ¨)ï¼š${e}`);
      await fallbackScriptProcessor(source);
    }

    txTimer = setInterval(()=>{ $('#tx').textContent = `TX: ${txPkts} pkt/s`; txPkts=0; }, 1000);
    $('#join').disabled=true; $('#leave').disabled=false;
    pingTimer = setInterval(()=>{ try{ ws.send(JSON.stringify({type:"ping"})); }catch(_){ } }, 20000);
  };

  ws.onmessage = async (ev)=>{
    if(ev.data instanceof ArrayBuffer){
      // â˜… åªæ’­æ”¾ MP3ï¼ˆè­¯éŸ³ï¼‰ã€‚è‹¥ç‚º WAVï¼ˆåŸéŸ³ï¼‰ï¼Œç›´æ¥å¿½ç•¥ã€‚
      const buf = ev.data;
      const isWav = (buf.byteLength>=12) && (new TextDecoder().decode(new DataView(buf,0,4))==='RIFF') &&
                    (new TextDecoder().decode(new DataView(buf,8,4))==='WAVE');
      if (isWav) { /* å¿½ç•¥åŸéŸ³ */ return; }

      const blob = new Blob([buf],{type:'audio/mpeg'});
      const url  = URL.createObjectURL(blob);
      const a = new Audio(url);
      a.autoplay = true;

      // æ’­æ”¾æœŸé–“å•Ÿç”¨ Ducking æŠ‘åˆ¶ï¼Œé¿å…ã€Œä¸­â†’éŸ“â†’ä¸­ã€å›å‚³éˆ
      a.addEventListener('play', ()=>{ playbackCount++; });
      a.addEventListener('ended', ()=>{ playbackCount=Math.max(0,playbackCount-1); lastPlaybackEndAt=performance.now(); URL.revokeObjectURL(url); });
      a.addEventListener('error', ()=>{ playbackCount=Math.max(0,playbackCount-1); lastPlaybackEndAt=performance.now(); URL.revokeObjectURL(url); });

      if (typeof a.setSinkId === 'function' && $('#outSel').value){
        try { await a.setSinkId($('#outSel').value); } catch(e){ log(`âš ï¸ è¨­å®šè¼¸å‡ºå¤±æ•—(ì¶œë ¥ ì„¤ì • ì‹¤íŒ¨)ï¼š${e}`); }
      }
      a.play().catch(()=>{});
      return;
    }
    try{
      const o=JSON.parse(ev.data);
      if(o.type==="join")  log(`ğŸ”µ ${o.name} åŠ å…¥(ì…ì¥)ï¼Œäººæ•¸/ì¸ì› ${o.count}`);
      if(o.type==="leave") log(`âšª ${o.name} é›¢é–‹(ë‚˜ê°€ê¸°)ï¼Œäººæ•¸/ì¸ì› ${o.count}`);
      if(o.type==="final") log(`âœ… ${o.from}ï¼ˆ${o.dir}ï¼‰\nåŸæ–‡/ì›ë¬¸ï¼š${o.text}\nç¿»è­¯/ë²ˆì—­ï¼š${o.mt}`);
      if(o.type==="mute")  log(`ğŸ”‡ ${o.name} ${o.muted?"å·²éœéŸ³(ìŒì†Œê±°)":"å–æ¶ˆéœéŸ³(í•´ì œ)"}`);
      if(o.type==="error") log(`âŒ ${o.msg}`);
    }catch(_){}
  };

  ws.onclose = ()=>{ log("é€£ç·šé—œé–‰(ì—°ê²° ì¢…ë£Œ)"); leave(); };
}

$('#join').onclick = join;
$('#leave').onclick = leave;
$('#mute').onchange = ()=>{ /* å³æ™‚ç”Ÿæ•ˆ */ };
navigator.mediaDevices.addEventListener('devicechange', refreshDevices);
(async ()=>{ try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch(_){ } await refreshDevices(); })();
</script>
</body>
</html>
