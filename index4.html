<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï¼ˆå–®æˆ¿ã€é‚Šèªªé‚Šæ’­ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial;padding:20px;max-width:900px;margin:auto}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  input[type=text], select{padding:8px 10px;border:1px solid #ccc;border-radius:10px;min-width:180px}
  button{padding:8px 14px;border-radius:10px;border:1px solid #bbb;background:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .pill{padding:4px 10px;border-radius:999px;background:#efefef;font-size:12px}
  .logs{margin-top:12px;padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;height:340px;overflow:auto;font-size:14px;white-space:pre-wrap}
  .now{color:#1b7fbd}
  #meter{width:180px;height:10px;background:#eee;border-radius:6px;overflow:hidden}
  #bar{display:block;height:100%;width:0%;background:#4caf50}
</style>
<body>
  <h2>ä¸­â†”éŸ“ åŒè²å‚³è­¯ï¼ˆå–®ä¸€æˆ¿é–“ï¼‰</h2>

  <div class="row">
    <label>åç¨±</label>
    <input id="name" type="text" placeholder="ä½ çš„åå­—">
    <button id="join">åŠ å…¥</button>
    <button id="leave" disabled>é›¢é–‹</button>
    <span class="pill" id="status">æœªé€£ç·š</span>
    <span class="pill" id="tx">TX: 0 pkt/s</span>
  </div>

  <div class="row">
    <strong>è¼¸å…¥ä¾†æºï¼š</strong>
    <label><input type="radio" name="mode" value="mic" checked> éº¥å…‹é¢¨</label>
    <label><input type="radio" name="mode" value="tab"> åˆ†é éŸ³è¨Šï¼ˆShare Tabï¼‰</label>
    <select id="device"></select>
    <button id="refresh">åˆ·æ–°è£ç½®</button>
    <span id="meter" title="è¼¸å…¥éŸ³é‡"><span id="bar"></span></span>
  </div>

  <div class="row">
    <label><input id="mute" type="checkbox"> å°è‡ªå·±ç¦éŸ³ï¼ˆä¸é€å‡ºéŸ³è¨Šï¼‰</label>
    <label><input id="playSelf" type="checkbox" checked> æ’­æ”¾è‡ªå·±çš„è­¯éŸ³</label>
    <label><input id="echo" type="checkbox" checked> å›è²æŠ‘åˆ¶</label>
    <label><input id="ns" type="checkbox" checked> é™å™ª</label>
    <label><input id="agc" type="checkbox" checked> è‡ªå‹•å¢ç›Š</label>
  </div>

  <div class="logs" id="logs"></div>

<script>
/* æ›æˆä½ ç•¶å‰ cloudflared çš„ä¸»æ©Ÿåï¼ˆä¸è¦å« https://ï¼‰ */
const TUNNEL_HOST = "room-rug-submitted-invitations.trycloudflare.com";

let ws=null, audioCtx=null, worklet=null, stream=null, sourceNode=null, analyser=null, meterTimer=null;
let sinkNode=null; // é›¶éŸ³é‡è¼¸å‡ºï¼Œç¢ºä¿ worklet è¢«æ‹‰å‹•
let pingTimer=null, txTimer=null, playQueue=[], playing=false, joined=false;
let sentPkts = 0, lastPkts = 0;

const $  = (s)=>document.querySelector(s);
const log= (s)=>{ const el=$('#logs'); el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight; };

async function enumerateInputs(){
  const devs = await navigator.mediaDevices.enumerateDevices();
  const inputs = devs.filter(d=>d.kind==='audioinput');
  const sel = $('#device'); sel.innerHTML='';
  inputs.forEach(d=>{
    const opt=document.createElement('option');
    opt.value=d.deviceId;
    opt.textContent=d.label || `éŸ³è¨Šè¼¸å…¥ (${d.deviceId.slice(0,6)})`;
    sel.appendChild(opt);
  });
}
$('#refresh').onclick = async ()=>{
  try{ await navigator.mediaDevices.getUserMedia({audio:true}); }catch(_){}
  await enumerateInputs();
};

async function startMicInput(){
  const deviceId = $('#device').value || undefined;
  const constraints = {
    audio:{
      deviceId: deviceId ? {exact:deviceId} : undefined,
      channelCount:2, // è®“ç€è¦½å™¨çµ¦åŸç”Ÿè²é“ï¼›æˆ‘å€‘è‡ªå·±æ··å–®è²é“
      sampleRate:48000,
      echoCancellation: $('#echo').checked,
      noiseSuppression: $('#ns').checked,
      autoGainControl:  $('#agc').checked
    }
  };
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  setupAudioGraph();
}
async function startTabAudioInput(){
  const disp = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  const atrack = disp.getAudioTracks()[0];
  if(!atrack){
    alert('æ²’æœ‰å–å¾—åˆ†é éŸ³è¨Šã€‚è«‹åœ¨é¸å–®ä¸­é¸ã€Œåˆ†é ã€ä¸¦å‹¾é¸ã€Œåˆ†äº«éŸ³è¨Šã€ã€‚');
    throw new Error('no tab audio');
  }
  disp.getVideoTracks().forEach(t=>t.stop());
  stream = new MediaStream([atrack]);
  setupAudioGraph(/*fromTab=*/true);
}

function setupAudioGraph(fromTab=false){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:48000});

  // æŸäº›ç€è¦½å™¨æœƒåœ¨æ²’ä½¿ç”¨è€…äº’å‹•æ™‚æŠŠ context æ›èµ·ï¼Œä¿éšªèµ·è¦‹ resume ä¸€ä¸‹
  audioCtx.resume?.();

  sourceNode = audioCtx.createMediaStreamSource(stream);

  // éŸ³é‡æ¢
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  sourceNode.connect(analyser);

  // 0 éŸ³é‡ sinkï¼Œç¢ºä¿ graph è¢«æ‹‰å‹•
  sinkNode = audioCtx.createGain();
  sinkNode.gain.value = 0.0;
  sinkNode.connect(audioCtx.destination);

  // Workletï¼šæ··å–®è²é“ + 48kâ†’16kï¼Œåˆ‡ 20ms/åŒ… ä¸Ÿå›ä¸»åŸ·è¡Œç·’
  const blobURL = URL.createObjectURL(new Blob([`
    class PCMWorklet extends AudioWorkletProcessor {
      constructor(){ super(); this.srcRate=sampleRate; this.dstRate=16000; }
      process(inputs, outputs, parameters){
        const input=inputs[0];
        if(!input || input.length===0) return true;
        // æ··å–®è²é“
        const ch0 = input[0] || new Float32Array(128);
        let mono;
        if(input.length>=2 && input[1]){
          const c1 = input[1]; mono = new Float32Array(ch0.length);
          for(let i=0;i<mono.length;i++){ mono[i] = 0.5*(ch0[i] + c1[i]); }
        }else{
          mono = ch0;
        }
        // 48k -> 16k ç°¡å–®æŠ½å–ï¼ˆè¶³å¤ å‚³ VAD/ASRï¼‰
        const ratio=this.srcRate/this.dstRate;
        const outLen=Math.floor(mono.length/ratio);
        const pcm=new Int16Array(outLen);
        for(let i=0;i<outLen;i++){
          const idx=Math.floor(i*ratio); let s=mono[idx] || 0;
          s=Math.max(-1,Math.min(1,s)); pcm[i]=s<0?s*0x8000:s*0x7FFF;
        }
        // æ¯ 20msï¼ˆ320 samples@16kï¼‰ä¸Ÿä¸€åŒ…åˆ°ä¸»åŸ·è¡Œç·’
        const pkt=320;
        for(let off=0; off<pcm.length; off+=pkt){
          const sl=pcm.subarray(off, off+pkt);
          if(sl.length===pkt) this.port.postMessage(sl.buffer,[sl.buffer]);
        }
        // æŠŠéœéŸ³é€åˆ°è¼¸å‡ºï¼Œç¢ºä¿ç¯€é»è¢«æ‹‰å‹•
        const out = outputs[0];
        if(out && out[0]){ out[0].fill(0); }
        return true;
      }
    }
    registerProcessor('pcm-worklet', PCMWorklet);
  `], {type:'application/javascript'}));

  audioCtx.audioWorklet.addModule(blobURL).then(()=>{
    worklet = new AudioWorkletNode(audioCtx, 'pcm-worklet', {
      numberOfInputs:1, numberOfOutputs:1, outputChannelCount:[1]
    });
    worklet.port.onmessage = (e)=>{
      if(!$('#mute').checked && ws && ws.readyState===1){
        ws.send(e.data);
        sentPkts++;
      }
    };
    // é—œéµï¼šæŠŠ worklet æ¥åˆ°é›¶éŸ³é‡ sinkï¼Œç¢ºä¿æœƒè¢«è™•ç†ï¼ˆä¸æœƒç™¼è²ï¼‰
    sourceNode.connect(worklet);
    worklet.connect(sinkNode);
  });

  startMeter();
}

function startMeter(){
  stopMeter();
  const bar = $('#bar');
  const buf = new Float32Array(analyser.fftSize);
  const tick = ()=>{
    analyser.getFloatTimeDomainData(buf);
    let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum += v*v; }
    const rms = Math.sqrt(sum/buf.length);
    const pct = Math.min(100, Math.round(rms*2000));
    bar.style.width = pct + '%';
    meterTimer = requestAnimationFrame(tick);
  };
  tick();
}
function stopMeter(){
  try{ cancelAnimationFrame(meterTimer); }catch(_){}
  meterTimer=null;
  $('#bar').style.width='0%';
}

async function join(){
  if (joined) return;
  const name = $('#name').value.trim() || 'Guest';

  const wsUrl = `wss://${TUNNEL_HOST}/ws`;
  console.log("WS URL =", wsUrl);
  ws = new WebSocket(wsUrl);
  ws.binaryType = 'arraybuffer';

  ws.onopen = async ()=>{
    $('#status').textContent="å·²é€£ç·š"; $('#status').classList.add('now');
    ws.send(JSON.stringify({name, play_self: $('#playSelf').checked}));

    const mode = document.querySelector('input[name="mode"]:checked').value;
    try{
      if(mode==='tab') await startTabAudioInput();
      else await startMicInput();
    }catch(e){
      log('âŒ ç„¡æ³•å•Ÿå‹•éŸ³æºï¼š' + e);
      return;
    }

    joined = true; $('#join').disabled=true; $('#leave').disabled=false;

    pingTimer = setInterval(()=>{ try{ ws.send(JSON.stringify({type:"ping"})); }catch(_){ } }, 20000);
    txTimer   = setInterval(()=>{
      const diff = sentPkts - lastPkts; lastPkts = sentPkts;
      $('#tx').textContent = `TX: ${diff} pkt/s`;
    }, 1000);

    enumerateInputs().catch(()=>{});
  };

  ws.onmessage = (ev)=>{
    if(ev.data instanceof ArrayBuffer){
      playQueue.push(ev.data);
      if(!playing) playNext();
      return;
    }
    try{
      const o=JSON.parse(ev.data);
      if(o.type==="join")   log(`ğŸ”µ ${o.name} åŠ å…¥ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="leave")  log(`âšª ${o.name} é›¢é–‹ï¼Œäººæ•¸ ${o.count}`);
      if(o.type==="mute")   log(`ğŸ”‡ ${o.name} ${o.muted?"å·²éœéŸ³":"å–æ¶ˆéœéŸ³"}`);
      if(o.type==="partial")log(`ğŸ“ ${o.from}ï¼ˆ${o.dir}ï¼‰\n${o.text}`);
      if(o.type==="simul")  log(`ğŸ§ ${o.from}ï¼ˆ${o.dir} é‚Šæ’­ï¼‰\næ–°å¢ï¼š${o.src_add}\nç¿»è­¯ï¼š${o.mt_add}`);
      if(o.type==="final")  log(`âœ… ${o.from}ï¼ˆ${o.dir} å®Œæ•´ï¼‰\nåŸæ–‡ï¼š${o.text}\nç¿»è­¯ï¼š${o.mt}`);
      if(o.type==="stat")   log(`ğŸ“¶ ${o.from} ä¸Šè¡Œ: ${o.rx_frames} frames`);
      if(o.type==="error")  log(`âŒ ${o.msg}`);
    }catch(_){}
  };

  ws.onclose = ()=>{
    log("é€£ç·šé—œé–‰");
    $('#status').textContent="æœªé€£ç·š"; $('#status').classList.remove('now');
    $('#join').disabled=false; $('#leave').disabled=true;
    cleanupAudio(); joined=false;
  };
}

function cleanupAudio(){
  try{ worklet && worklet.disconnect(); }catch(_){}
  try{ sinkNode && sinkNode.disconnect(); }catch(_){}
  try{ sourceNode && sourceNode.disconnect(); }catch(_){}
  try{ stream && stream.getTracks().forEach(t=>t.stop()); }catch(_){}
  try{ audioCtx && audioCtx.close(); }catch(_){}
  try{ clearInterval(pingTimer); }catch(_){}
  try{ clearInterval(txTimer); }catch(_){}
  stopMeter();
  worklet=null; sinkNode=null; sourceNode=null; audioCtx=null; stream=null; pingTimer=null; txTimer=null;
}

function leave(){
  if(ws){ try{ ws.close(); }catch(_){} }
  cleanupAudio();
  $('#join').disabled=false; $('#leave').disabled=true; joined=false;
}

async function playNext(){
  if(playQueue.length===0){ playing=false; return; }
  playing=true;
  const buf=playQueue.shift();
  const blob=new Blob([buf],{type:'audio/wav'});
  const url=URL.createObjectURL(blob);
  const a=new Audio(url);
  a.onended=()=>{ URL.revokeObjectURL(url); playNext(); };
  a.play().catch(()=>{ /* æŸäº›ç€è¦½å™¨éœ€äº’å‹•æˆæ¬Šæ‰è‡ªå‹•æ’­æ”¾ */ });
}

$('#join').onclick = join;
$('#leave').onclick = leave;
$('#mute').onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'mute', value:$('#mute').checked})); };
$('#playSelf').onchange = ()=>{ if(ws && ws.readyState===1) ws.send(JSON.stringify({type:'play_self', value:$('#playSelf').checked})); };

// åˆå§‹åˆ—å‡ºè£ç½®ï¼ˆæ²’æœ‰æ¬Šé™æ™‚åç¨±å¯èƒ½æ˜¯ç©ºç™½ï¼‰
enumerateInputs().catch(()=>{});
// è‹¥ä½¿ç”¨è€…æ‹”æ’è€³æ©Ÿ/è—ç‰™è£ç½®æ™‚è‡ªå‹•åˆ·æ–°
navigator.mediaDevices.addEventListener?.('devicechange', ()=> enumerateInputs().catch(()=>{}));
</script>
</body>
</html>
